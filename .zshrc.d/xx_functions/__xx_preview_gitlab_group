#!/usr/bin/env zsh

function __xx_preview_gitlab_group() {
    local GROUP_NAME="${1}"
    local GROUP_ID="${2}"
    local GITLAB_URL="${3}"
    
    if [[ -z "${GROUP_NAME}" || -z "${GROUP_ID}" || -z "${GITLAB_URL}" ]]; then
        echo "Invalid group information"
        return 1
    fi
    
    # Extract GitLab host from URL
    local GITLAB_HOST=$(echo "${GITLAB_URL}" | sed -E 's|^[a-z]+://([^/.:]+(\.[^/.:]+)*).*|\1|')
    
    # Find the correct config file for this GitLab host
    local CONFIG_FOUND=false
    local CONFIG_DIR=""
    
    for CONFIG_FILE in $(find "${HOME}/.config/glab-cli/" -name 'config.yml'); do
        local TEST_CONFIG_DIR=$(dirname ${CONFIG_FILE})
        # Test if this config works by trying to fetch group info
        local test_result=$(GLAB_CONFIG_DIR="${TEST_CONFIG_DIR}" GITLAB_HOST="${GITLAB_HOST}" glab api "groups/${GROUP_ID}" 2>/dev/null)
        if [[ -n "${test_result}" ]]; then
            CONFIG_FOUND=true
            CONFIG_DIR="${TEST_CONFIG_DIR}"
            break
        fi
    done
    
    if [[ "${CONFIG_FOUND}" == "false" ]]; then
        echo "Unable to find credentials for ${GITLAB_HOST}"
        return 1
    fi
    
    # Group name
    printf '\033[1;33mGroup:\033[0m\n'
    echo "${GROUP_NAME}"
    echo
    
    # Fetch group data once
    local group_data=$(GLAB_CONFIG_DIR="${CONFIG_DIR}" GITLAB_HOST="${GITLAB_HOST}" glab api "groups/${GROUP_ID}" 2>/dev/null)
    
    # Description
    printf '\033[1;33mDescription:\033[0m\n'
    echo "${group_data}" | jq -r '.description // "No description"' 2>/dev/null
    echo
    
    # Full Path
    printf '\033[1;33mFull Path:\033[0m\n'
    echo "${group_data}" | jq -r '.full_path // "N/A"' 2>/dev/null
    echo
    
    # Visibility
    printf '\033[1;33mVisibility:\033[0m\n'
    echo "${group_data}" | jq -r '.visibility // "N/A"' 2>/dev/null
    echo
    
    # Projects Count
    printf '\033[1;33mProjects:\033[0m\n'
    local projects_count=$(GLAB_CONFIG_DIR="${CONFIG_DIR}" GITLAB_HOST="${GITLAB_HOST}" glab api "groups/${GROUP_ID}/projects" --paginate=false 2>/dev/null | jq '. | length' 2>/dev/null)
    echo "${projects_count:-0} project(s)"
    echo
    
    # Subgroups Count
    printf '\033[1;33mSubgroups:\033[0m\n'
    local subgroups_count=$(GLAB_CONFIG_DIR="${CONFIG_DIR}" GITLAB_HOST="${GITLAB_HOST}" glab api "groups/${GROUP_ID}/subgroups" --paginate=false 2>/dev/null | jq '. | length' 2>/dev/null)
    echo "${subgroups_count:-0} subgroup(s)"
    echo
    
    # Members Count
    printf '\033[1;33mMembers:\033[0m\n'
    local members_count=$(GLAB_CONFIG_DIR="${CONFIG_DIR}" GITLAB_HOST="${GITLAB_HOST}" glab api "groups/${GROUP_ID}/members" --paginate=false 2>/dev/null | jq '. | length' 2>/dev/null)
    echo "${members_count:-0} member(s)"
}
