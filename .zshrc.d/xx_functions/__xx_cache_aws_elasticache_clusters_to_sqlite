__xx_cache_aws_elasticache_clusters_to_sqlite() {
    source ~/.zshrc.d/xx_functions/__xx_setup_commands
    source ~/.zshrc.d/xx_functions/__xx_format_columns_ansi
    __xx_setup_commands
    source ~/.zshrc.d/xx_functions/__xx_notify

    if [ -z "${XX_CACHE_DIR}" ]; then
        __xx_notify "Environment variable XX_CACHE_DIR is not defined, quitting"
        return 1
    fi

    if [[ ! -n "${AWS_SESSION_TOKEN}" || ! -n "${AWS_VAULT}" ]]; then
        __xx_notify "AWS vault is not enabled."
        return 1
    fi

    __xx_notify "#[fg=bold]Starting to fetch AWS ElastiCache Clusters!#[default]"

    __xx_notify "Ensuring ${XX_CACHE_DIR} directory exists"
    mkdir -p "${XX_CACHE_DIR}"
    SQLITE_DATABASE_PATH="${XX_CACHE_DIR}/aws_elasticache.db"

    local ACCOUNT="${AWS_VAULT}"
    local REGION="${AWS_REGION}"

    __xx_notify "Creating tables if not exist in SQLITE database"
    sqlite3 "${SQLITE_DATABASE_PATH}" "CREATE TABLE IF NOT EXISTS Clusters (account TEXT NOT NULL, region TEXT NOT NULL, cluster_id TEXT NOT NULL, engine TEXT NOT NULL, engine_version TEXT NOT NULL, node_type TEXT NOT NULL, cluster_status TEXT NOT NULL, num_nodes INTEGER NOT NULL, UNIQUE (account, region, cluster_id));"
    sqlite3 "${SQLITE_DATABASE_PATH}" "CREATE TABLE IF NOT EXISTS SyncLog (account TEXT NOT NULL, region TEXT NOT NULL, sync_timestamp TEXT NOT NULL, PRIMARY KEY (account, region));"

    if [ -n "${SQLITE_WIPE_DATA}" ]; then
        __xx_notify "Wipe table data"
        sqlite3 "${SQLITE_DATABASE_PATH}" "DELETE FROM Clusters WHERE account = '${ACCOUNT}' AND region = '${REGION}';"
    fi

    __xx_notify "Fetching ElastiCache clusters for account: ${ACCOUNT}, region: ${REGION}"

    sqlite3 "${SQLITE_DATABASE_PATH}" "DELETE FROM Clusters WHERE account = '${ACCOUNT}' AND region = '${REGION}';"

    # Fetch Redis replication groups (clusters)
    aws elasticache describe-replication-groups --output json 2>/dev/null | \
        jq -r '.ReplicationGroups[] | [.ReplicationGroupId, "redis", (.CacheNodeType // "N/A"), .Status, ([.MemberClusters] | length)] | @tsv' | \
        while IFS=$'\t' read -r cluster_id engine node_type cluster_status num_nodes; do
            cluster_id_escaped=$(echo "$cluster_id" | sed "s/'/''/g")
            engine_escaped=$(echo "$engine" | sed "s/'/''/g")
            node_type_escaped=$(echo "$node_type" | sed "s/'/''/g")
            cluster_status_escaped=$(echo "$cluster_status" | sed "s/'/''/g")
            # Get engine version from one of the member clusters
            engine_version=$(aws elasticache describe-replication-groups --replication-group-id "$cluster_id" --output json 2>/dev/null | jq -r '.ReplicationGroups[0].MemberClusters[0]' | xargs -I {} aws elasticache describe-cache-clusters --cache-cluster-id {} --output json 2>/dev/null | jq -r '.CacheClusters[0].EngineVersion // "N/A"')
            engine_version_escaped=$(echo "$engine_version" | sed "s/'/''/g")
            sqlite3 "${SQLITE_DATABASE_PATH}" "INSERT OR REPLACE INTO Clusters (account, region, cluster_id, engine, engine_version, node_type, cluster_status, num_nodes) VALUES ('${ACCOUNT}', '${REGION}', '${cluster_id_escaped}', '${engine_escaped}', '${engine_version_escaped}', '${node_type_escaped}', '${cluster_status_escaped}', ${num_nodes});"
        done

    # Fetch standalone Memcached clusters (not in replication groups)
    aws elasticache describe-cache-clusters --output json 2>/dev/null | \
        jq -r '.CacheClusters[] | select(.ReplicationGroupId == null) | [.CacheClusterId, .Engine, .EngineVersion, .CacheNodeType, .CacheClusterStatus, .NumCacheNodes] | @tsv' | \
        while IFS=$'\t' read -r cluster_id engine engine_version node_type cluster_status num_nodes; do
            cluster_id_escaped=$(echo "$cluster_id" | sed "s/'/''/g")
            engine_escaped=$(echo "$engine" | sed "s/'/''/g")
            engine_version_escaped=$(echo "$engine_version" | sed "s/'/''/g")
            node_type_escaped=$(echo "$node_type" | sed "s/'/''/g")
            cluster_status_escaped=$(echo "$cluster_status" | sed "s/'/''/g")
            sqlite3 "${SQLITE_DATABASE_PATH}" "INSERT OR REPLACE INTO Clusters (account, region, cluster_id, engine, engine_version, node_type, cluster_status, num_nodes) VALUES ('${ACCOUNT}', '${REGION}', '${cluster_id_escaped}', '${engine_escaped}', '${engine_version_escaped}', '${node_type_escaped}', '${cluster_status_escaped}', ${num_nodes});"
        done

    __xx_notify "Creating 'SyncLog' table if not exists in SQLITE database"
    SYNC_TIMESTAMP=$(${XX_GNU_DATE_COMMAND} -u +"%Y-%m-%dT%H:%M:%SZ")
    sqlite3 "${SQLITE_DATABASE_PATH}" "INSERT OR REPLACE INTO SyncLog (account, region, sync_timestamp) VALUES ('${ACCOUNT}', '${REGION}', '${SYNC_TIMESTAMP}');"

    __xx_notify "#[fg=bold]Finished fetching AWS ElastiCache Clusters!#[default]"
}
