#!/usr/bin/env zsh

function __xx_preview_github_notification() {
    source ~/.zshrc.d/xx_functions/__xx_setup_commands
    __xx_setup_commands
    local NOTIFICATION_ID=$1

    # Strip ANSI color codes from the ID if present
    NOTIFICATION_ID=$(printf '%s' "${NOTIFICATION_ID}" | sed $'s/\033\\[[0-9;]*m//g' | tr -d '[:space:]')

    if [[ -z "${NOTIFICATION_ID}" ]]; then
        echo "Invalid notification information"
        return 1
    fi

    if [[ ! -f "${XX_CACHE_DIR}/github.db" ]]; then
        echo "github.db cache doesn't exist"
        return 1
    fi

    # Fetch the notification JSON from the cache
    local NOTIFICATION_JSON=$(sqlite3 --json "${XX_CACHE_DIR}/github.db" \
        "SELECT json FROM Notifications WHERE id='${NOTIFICATION_ID}';" 2>/dev/null | jq -r '.[0].json')

    if [[ -z "${NOTIFICATION_JSON}" || "${NOTIFICATION_JSON}" == "null" ]]; then
        echo "Notification ID ${NOTIFICATION_ID} not found in cache"
        return 1
    fi

    # Extract notification details
    local REPO=$(echo "${NOTIFICATION_JSON}" | jq -r '.repository.full_name')
    local TITLE=$(echo "${NOTIFICATION_JSON}" | jq -r '.subject.title')
    local TYPE=$(echo "${NOTIFICATION_JSON}" | jq -r '.subject.type')
    local REASON=$(echo "${NOTIFICATION_JSON}" | jq -r '.reason')
    local UNREAD=$(echo "${NOTIFICATION_JSON}" | jq -r '.unread')
    local UPDATED_AT=$(echo "${NOTIFICATION_JSON}" | jq -r '.updated_at')
    local SUBJECT_URL=$(echo "${NOTIFICATION_JSON}" | jq -r '.subject.url')

    # Display notification details
    printf '\033[1;33mNotification:\033[0m\n'
    echo "${TITLE}"
    echo

    printf '\033[1;33mRepository:\033[0m\n'
    echo "${REPO}"
    echo

    printf '\033[1;33mType:\033[0m\n'
    echo "${TYPE}"
    echo

    printf '\033[1;33mReason:\033[0m\n'
    echo "${REASON}"
    echo

    printf '\033[1;33mStatus:\033[0m\n'
    if [[ "${UNREAD}" == "true" ]]; then
        echo "Unread"
    else
        echo "Read"
    fi
    echo

    printf '\033[1;33mLast Updated:\033[0m\n'
    if [[ "${UPDATED_AT}" != "null" && -n "${UPDATED_AT}" ]]; then
        echo "${UPDATED_AT}" | sed 's/T/ /' | cut -d'Z' -f1
    else
        echo "N/A"
    fi
    echo

    # Try to fetch additional details based on notification type
    if [[ "${SUBJECT_URL}" != "null" && -n "${SUBJECT_URL}" ]]; then
        printf '\033[1;33mDetails:\033[0m\n'

        # Extract repo and issue/PR number from subject URL
        # URL format: https://api.github.com/repos/owner/repo/issues/123
        local API_PATH=$(echo "${SUBJECT_URL}" | sed 's|https://api.github.com||')

        case "${TYPE}" in
            "PullRequest")
                gh api "${API_PATH}" 2>/dev/null | jq -r '
                    "State: \(.state)",
                    "Author: \(.user.login)",
                    "Created: \(.created_at | split("T")[0])",
                    "",
                    "Description:",
                    (.body // "No description" | split("\n")[0:5] | join("\n"))
                ' 2>/dev/null || echo "Unable to fetch PR details"
                ;;
            "Issue")
                gh api "${API_PATH}" 2>/dev/null | jq -r '
                    "State: \(.state)",
                    "Author: \(.user.login)",
                    "Created: \(.created_at | split("T")[0])",
                    "Comments: \(.comments)",
                    "",
                    "Description:",
                    (.body // "No description" | split("\n")[0:5] | join("\n"))
                ' 2>/dev/null || echo "Unable to fetch issue details"
                ;;
            "Release")
                gh api "${API_PATH}" 2>/dev/null | jq -r '
                    "Tag: \(.tag_name)",
                    "Name: \(.name // "N/A")",
                    "Published: \(.published_at | split("T")[0])",
                    "",
                    "Notes:",
                    (.body // "No release notes" | split("\n")[0:10] | join("\n"))
                ' 2>/dev/null || echo "Unable to fetch release details"
                ;;
            "Commit")
                gh api "${API_PATH}" 2>/dev/null | jq -r '
                    "Author: \(.commit.author.name)",
                    "Date: \(.commit.author.date | split("T")[0])",
                    "",
                    "Message:",
                    (.commit.message | split("\n")[0:5] | join("\n"))
                ' 2>/dev/null || echo "Unable to fetch commit details"
                ;;
            *)
                echo "No additional details available for type: ${TYPE}"
                ;;
        esac
    fi
}
