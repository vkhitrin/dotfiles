__xx_get_argocd_applications() {
    local XX_ARGOCD_SERVER=${1}

    # Debug: show what server we received
    if [ -z "${XX_ARGOCD_SERVER}" ]; then
        echo "ERROR: No server provided to __xx_get_argocd_applications"
        return 1
    fi

    local APPLICATIONS=$(argocd app list --server "${XX_ARGOCD_SERVER}" 2>/dev/null)
    local EXIT_CODE=$?

    if [ ${EXIT_CODE} -ne 0 ]; then
        echo "ERROR: Failed to list applications for server '${XX_ARGOCD_SERVER}'"
        return 1
    fi

    if [ -n "${APPLICATIONS}" ]; then
        # Convert to CSV format with colors and format using __xx_format_columns_ansi
        {
            echo "NAME,CLUSTER,NAMESPACE,PROJECT,STATUS,HEALTH,SYNCPOLICY,CONDITIONS,SERVER"
            echo "${APPLICATIONS}" | awk -v srv="${XX_ARGOCD_SERVER}" '
            NR==1 {
                # Skip header from argocd output
                next
            }
            NR>1 {
                # Extract fields
                APP=$1
                CLUSTER=$2
                NAMESPACE=$3
                PROJECT=$4
                STATUS=$5
                HEALTH=$6
                SYNCPOLICY=$7
                CONDITIONS=$8

                # Color code sync status
                if (STATUS == "Synced")
                    STATUS="\033[1;32m" STATUS "\033[0m"
                else if (STATUS == "OutOfSync")
                    STATUS="\033[1;33m" STATUS "\033[0m"
                else
                    STATUS="\033[1;37m" STATUS "\033[0m"

                # Color code health status
                if (HEALTH == "Healthy")
                    HEALTH="\033[1;32m" HEALTH "\033[0m"
                else if (HEALTH == "Degraded")
                    HEALTH="\033[1;31m" HEALTH "\033[0m"
                else if (HEALTH == "Progressing")
                    HEALTH="\033[1;33m" HEALTH "\033[0m"
                else
                    HEALTH="\033[1;37m" HEALTH "\033[0m"

                printf "%s,%s,%s,%s,%s,%s,%s,%s,%s\n", APP, CLUSTER, NAMESPACE, PROJECT, STATUS, HEALTH, SYNCPOLICY, CONDITIONS, srv
            }'
        } | __xx_format_columns_ansi ","
    else
        echo "No applications found for server ${XX_ARGOCD_SERVER}"
    fi
}
