__xx_refresh_all_1password_field_caches() {
    source ~/.zshrc.d/xx_functions/__xx_get_1password_item_fields
    source ~/.zshrc.d/xx_functions/__xx_notify
    source ~/.zshrc.d/xx_functions/__xx_refresh_1password_keychain_entry

    local MAX_PROCESSES="${1:-4}"  # Default to 4 parallel processes
    local TEMP_DIR=$(mktemp -d -t xx_op)
    local PIDS=()
    local ITEM_COUNT=0
    local PROCESSED=0

    __xx_notify "Starting cache refresh for all 1password items (${MAX_PROCESSES} parallel processes)" 2000

    # Ensure we're authenticated
    __xx_refresh_1password_keychain_entry > /dev/null 2>&1

    # Get all item IDs
    local ITEM_IDS=$(op item list --format json 2>&1 | jq -r '.[].id' 2>&1)

    if [ -z "${ITEM_IDS}" ] || echo "${ITEM_IDS}" | grep -q "ERROR"; then
        __xx_notify "#[fg=#d20f39,bold]Failed to retrieve 1password items: ${ITEM_IDS}#[default]" 3000
        rm -rf "${TEMP_DIR}"
        return 1
    fi

    ITEM_COUNT=$(echo "${ITEM_IDS}" | wc -l | tr -d ' ')
    # Ensure ITEM_COUNT is an integer
    ITEM_COUNT=$((ITEM_COUNT + 0))
    __xx_notify "Found ${ITEM_COUNT} items to cache" 2000

    # Process items in batches
    local ITEM_INDEX=0
    local BATCH_NUM=0

    while IFS= read -r ITEM_ID; do
        [ -z "${ITEM_ID}" ] && continue

        ITEM_INDEX=$((ITEM_INDEX + 1))
        RESULT_FILE="${TEMP_DIR}/result_${ITEM_INDEX}"

        # Start background process - each sources the needed functions
        (
            source ~/.zshrc.d/xx_functions/__xx_get_1password_item_fields
            source ~/.zshrc.d/xx_functions/__xx_refresh_1password_keychain_entry

            # Use cache if available, refresh only if needed
            __xx_get_1password_item_fields "${ITEM_ID}" false false > /dev/null 2>&1

            if [ $? -eq 0 ]; then
                echo "success" > "${RESULT_FILE}"
            else
                echo "failed" > "${RESULT_FILE}"
            fi
        ) &

        PIDS+=($!)

        # Wait for batch to complete when we reach MAX_PROCESSES
        if [ ${#PIDS[@]} -ge ${MAX_PROCESSES} ]; then
            BATCH_NUM=$((BATCH_NUM + 1))

            # Wait for all processes in current batch
            for PID in "${PIDS[@]}"; do
                wait ${PID} 2>/dev/null
            done

            PROCESSED=$((BATCH_NUM * MAX_PROCESSES))
            # Calculate percentage with proper integer arithmetic
            if [ ${ITEM_COUNT} -gt 0 ]; then
                local PERCENT=$(( (PROCESSED * 100) / ITEM_COUNT ))
            else
                local PERCENT=0
            fi
            __xx_notify "Progress: ${PROCESSED}/${ITEM_COUNT} items cached (${PERCENT}%%)" 1500

            # Clear PIDs array for next batch
            PIDS=()
        fi
    done <<< "${ITEM_IDS}"

    # Wait for remaining processes in final batch
    if [ ${#PIDS[@]} -gt 0 ]; then
        BATCH_NUM=$((BATCH_NUM + 1))
        for PID in "${PIDS[@]}"; do
            wait ${PID} 2>/dev/null
        done
        __xx_notify "Progress: ${ITEM_COUNT}/${ITEM_COUNT} items cached (final batch)" 1500
    fi

    # Count successes and failures
    local SUCCESS_COUNT=0
    local FAILED_COUNT=0
    local RESULT_COUNT=0

    for RESULT_FILE in "${TEMP_DIR}"/result_*; do
        if [ -f "${RESULT_FILE}" ]; then
            RESULT_COUNT=$((RESULT_COUNT + 1))
            if grep -q "success" "${RESULT_FILE}" 2>/dev/null; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
                FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
        fi
    done

    # If we expected results but got none, count them as failures
    if [ ${RESULT_COUNT} -eq 0 ] && [ ${ITEM_COUNT} -gt 0 ]; then
        FAILED_COUNT=${ITEM_COUNT}
    elif [ ${RESULT_COUNT} -lt ${ITEM_COUNT} ]; then
        # Some processes didn't create result files
        FAILED_COUNT=$((FAILED_COUNT + ITEM_COUNT - RESULT_COUNT))
    fi

    # Cleanup
    rm -rf "${TEMP_DIR}"

    # Final notification
    if [ ${FAILED_COUNT} -eq 0 ]; then
        __xx_notify "#[fg=#40a02b,bold]Successfully cached fields for all ${SUCCESS_COUNT} items#[default]" 3000
    else
        __xx_notify "#[fg=#fe640b,bold]Cached ${SUCCESS_COUNT} items, ${FAILED_COUNT} failed#[default]" 3000
    fi

    return 0
}
