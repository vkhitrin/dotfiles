__xx_cache_aws_sqs_queues_to_sqlite() {
    source ~/.zshrc.d/xx_functions/__xx_setup_commands
    source ~/.zshrc.d/xx_functions/__xx_format_columns_ansi
    __xx_setup_commands
    source ~/.zshrc.d/xx_functions/__xx_notify

    if [ -z "${XX_CACHE_DIR}" ]; then
        __xx_notify "Environment variable XX_CACHE_DIR is not defined, quitting"
        return 1
    fi

    if [[ ! -n "${AWS_SESSION_TOKEN}" || ! -n "${AWS_VAULT}" ]]; then
        __xx_notify "AWS vault is not enabled."
        return 1
    fi

    __xx_notify "#[fg=bold]Starting to fetch AWS SQS Queues!#[default]"

    __xx_notify "Ensuring ${XX_CACHE_DIR} directory exists"
    mkdir -p "${XX_CACHE_DIR}"
    SQLITE_DATABASE_PATH="${XX_CACHE_DIR}/aws_sqs.db"

    local ACCOUNT="${AWS_VAULT}"
    local REGION="${AWS_REGION}"

    __xx_notify "Creating tables if not exist in SQLITE database"
    sqlite3 "${SQLITE_DATABASE_PATH}" "CREATE TABLE IF NOT EXISTS Queues (account TEXT NOT NULL, region TEXT NOT NULL, queue_url TEXT NOT NULL, queue_name TEXT NOT NULL, queue_type TEXT, approximate_messages INTEGER, approximate_messages_delayed INTEGER, approximate_messages_not_visible INTEGER, UNIQUE (account, region, queue_url));"
    sqlite3 "${SQLITE_DATABASE_PATH}" "CREATE TABLE IF NOT EXISTS SyncLog (account TEXT NOT NULL, region TEXT NOT NULL, sync_timestamp TEXT NOT NULL, PRIMARY KEY (account, region));"

    if [ -n "${SQLITE_WIPE_DATA}" ]; then
        __xx_notify "Wipe table data"
        sqlite3 "${SQLITE_DATABASE_PATH}" "DELETE FROM Queues WHERE account = '${ACCOUNT}' AND region = '${REGION}';"
    fi

    __xx_notify "Fetching SQS queues for account: ${ACCOUNT}, region: ${REGION}"

    sqlite3 "${SQLITE_DATABASE_PATH}" "DELETE FROM Queues WHERE account = '${ACCOUNT}' AND region = '${REGION}';"

    aws sqs list-queues --output json 2>/dev/null | \
        jq -r '.QueueUrls[]?' | \
        while read -r QUEUE_URL; do
            if [[ -z "${QUEUE_URL}" ]]; then
                continue
            fi

            QUEUE_NAME=$(basename "${QUEUE_URL}")

            # Get queue attributes
            ATTRS=$(aws sqs get-queue-attributes --queue-url "${QUEUE_URL}" --attribute-names All --output json 2>/dev/null)

            QUEUE_TYPE="Standard"
            if echo "${ATTRS}" | jq -e '.Attributes.FifoQueue == "true"' > /dev/null 2>&1; then
                QUEUE_TYPE="FIFO"
            fi

            APPROX_MESSAGES=$(echo "${ATTRS}" | jq -r '.Attributes.ApproximateNumberOfMessages // "0"')
            APPROX_DELAYED=$(echo "${ATTRS}" | jq -r '.Attributes.ApproximateNumberOfMessagesDelayed // "0"')
            APPROX_NOT_VISIBLE=$(echo "${ATTRS}" | jq -r '.Attributes.ApproximateNumberOfMessagesNotVisible // "0"')

            QUEUE_URL_ESCAPED=$(echo "${QUEUE_URL}" | sed "s/'/''/g")
            QUEUE_NAME_ESCAPED=$(echo "${QUEUE_NAME}" | sed "s/'/''/g")
            QUEUE_TYPE_ESCAPED=$(echo "${QUEUE_TYPE}" | sed "s/'/''/g")

            sqlite3 "${SQLITE_DATABASE_PATH}" "INSERT OR REPLACE INTO Queues (account, region, queue_url, queue_name, queue_type, approximate_messages, approximate_messages_delayed, approximate_messages_not_visible) VALUES ('${ACCOUNT}', '${REGION}', '${QUEUE_URL_ESCAPED}', '${QUEUE_NAME_ESCAPED}', '${QUEUE_TYPE_ESCAPED}', ${APPROX_MESSAGES}, ${APPROX_DELAYED}, ${APPROX_NOT_VISIBLE});"
        done

    __xx_notify "Creating 'SyncLog' table if not exists in SQLITE database"
    SYNC_TIMESTAMP=$(${XX_GNU_DATE_COMMAND} -u +"%Y-%m-%dT%H:%M:%SZ")
    sqlite3 "${SQLITE_DATABASE_PATH}" "INSERT OR REPLACE INTO SyncLog (account, region, sync_timestamp) VALUES ('${ACCOUNT}', '${REGION}', '${SYNC_TIMESTAMP}');"

    __xx_notify "#[fg=bold]Finished fetching AWS SQS Queues!#[default]"
}
